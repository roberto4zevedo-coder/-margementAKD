<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âmargement Collectif - AKD MIDEA Vitrolles</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 900px;
            margin: 0 auto;
            padding: 40px;
            border: 1px solid #e0e0e0;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .logo-text {
            font-size: 3em;
            font-weight: bold;
            color: #00A0E3;
            margin-bottom: 10px;
            letter-spacing: 3px;
        }

        h1 {
            color: #000;
            font-size: 1.8em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .date-info {
            color: #999;
            font-size: 0.9em;
        }

        .participants-list {
            margin-bottom: 30px;
        }

        .participants-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .participants-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .participants-count {
            background: #00A0E3;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
        }

        .participant-card {
            background: #fafafa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .participant-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .participant-number {
            background: #00A0E3;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .participant-details {
            flex: 1;
        }

        .participant-name {
            font-weight: 600;
            font-size: 1.1em;
            color: #333;
        }

        .participant-time {
            font-size: 0.85em;
            color: #999;
        }

        .participant-signature {
            max-width: 150px;
            max-height: 60px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 5px;
            background: white;
        }

        .form-section {
            background: #f9f9f9;
            border: 2px solid #00A0E3;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background-color: white;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: #00A0E3;
            box-shadow: 0 0 0 4px rgba(0, 160, 227, 0.1);
        }

        .signature-pad {
            border: 3px solid #e0e0e0;
            border-radius: 65px;
            cursor: crosshair;
            display: block;
            width: 100%;
            height: 275px;
            background-color: white;
            transition: border-color 0.3s ease;
        }

        .signature-pad:hover {
            border-color: #00A0E3;
        }

        .signature-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-clear {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        .btn-clear:hover {
            background-color: #c0392b;
        }

        .btn-add {
            background: #00A0E3;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
        }

        .btn-add:hover {
            background: #0087C3;
        }

        .btn-generate {
            background: #27ae60;
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .btn-generate:hover {
            background: #229954;
        }

        .btn-generate:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid #27ae60;
        }

        .toast.error {
            border-left: 4px solid #e74c3c;
        }

        .toast-icon {
            font-size: 1.5em;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .toast-message {
            color: #666;
            font-size: 0.9em;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: #999;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .logo-text {
                font-size: 2em;
            }

            .participant-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .participant-signature {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Toast notification -->
    <div class="toast" id="toast">
        <div class="toast-icon" id="toastIcon"></div>
        <div class="toast-content">
            <div class="toast-title" id="toastTitle"></div>
            <div class="toast-message" id="toastMessage"></div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Feuille d'√âmargement Collective</h1>
            <p class="subtitle">AKD - Vitrolles</p>
            <p class="date-info" id="currentDate"></p>
        </div>

        <!-- Liste des participants -->
        <div class="participants-list">
            <div class="participants-header">
                <div class="participants-title">Participants</div>
                <div class="participants-count" id="participantsCount">0</div>
            </div>
            <div id="participantsList">
                <div class="empty-state">
                    <div class="empty-state-icon">üìù</div>
                    <p>Aucun participant pour le moment</p>
                    <p style="font-size: 0.9em; margin-top: 10px;">Ajoutez le premier √©margement ci-dessous</p>
                </div>
            </div>
        </div>

        <!-- Formulaire d'ajout -->
        <div class="form-section">
            <h2 style="margin-bottom: 20px; color: #333; font-size: 1.3em;">‚ûï Ajouter un participant</h2>
            <form id="emargementForm">
                <div class="form-group">
                    <label for="prenom">S√©lectionnez votre pr√©nom *</label>
                    <select id="prenom" name="prenom" required>
                        <option value="">-- Choisir un pr√©nom --</option>
                        <option value="Baptiste Guillem">Guillem Baptiste </option>
                        <option value="Ornecq Christophe">Ornecq Christophe </option>
                        <option value="Mourinha Fabien ">Mourinha Fabien</option>
                        <option value="Atanasov Georgi">Atanasov Georgi</option>
                        <option value="DeGramaglia Hugo">DeGramaglia Hugo</option>
                        <option value="Capdeville Jeremy">Capdeville Jeremy </option>
                        <option value="Jonquiere Laurent">Jonquiere Laurent</option>
                        <option value="Enoch Jerome">Enoch Jerome</option>
                    </select>
                    <span class="error-message" id="prenomError">Veuillez s√©lectionner votre pr√©nom</span>
                </div>

                <div class="form-group">
                    <label for="signature">Votre signature *</label>
                    <canvas id="signaturePad" class="signature-pad"></canvas>
                    <span class="error-message" id="signatureError">Veuillez apposer votre signature</span>
                    <div class="signature-controls">
                        <button type="button" class="btn-clear" id="clearBtn">üóëÔ∏è Effacer</button>
                    </div>
                </div>

                <button type="submit" class="btn-add" id="addBtn">
                    ‚úì Ajouter ce participant
                </button>
            </form>
        </div>

        <!-- Bouton de g√©n√©ration PDF -->
        <button class="btn-generate" id="generateBtn" disabled>
            üìÑ G√©n√©rer le PDF de la feuille d'√©margement
        </button>

        <div class="footer">
            <p>¬© 2024 MIDEA HVAC France - Service Apr√®s-Vente</p>
        </div>
    </div>

    <script>
        // Variables globales
        let participants = [];
        const today = new Date();

        // Fonction pour afficher un toast
        function showToast(type, title, message) {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');

            toast.className = 'toast ' + type;
            toastIcon.textContent = type === 'success' ? '‚úì' : '‚úï';
            toastTitle.textContent = title;
            toastMessage.textContent = message;

            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Afficher la date actuelle
        const dateElement = document.getElementById('currentDate');
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        dateElement.textContent = today.toLocaleDateString('fr-FR', options);

        // Configuration du canvas de signature
        const canvas = document.getElementById('signaturePad');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let hasSignature = false;

        // Ajuster la taille du canvas
        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            ctx.scale(ratio, ratio);
        }

        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Configuration du style de dessin
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        // Fonctions de dessin
        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            hasSignature = true;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            ctx.lineTo(x, y);
            ctx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        // Events pour souris
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // Events pour tactile
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);

        // Bouton effacer
        document.getElementById('clearBtn').addEventListener('click', function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            hasSignature = false;
            document.getElementById('signatureError').classList.remove('show');
        });

        // Mettre √† jour l'affichage des participants
        function updateParticipantsList() {
            const list = document.getElementById('participantsList');
            const count = document.getElementById('participantsCount');
            const generateBtn = document.getElementById('generateBtn');

            count.textContent = participants.length;

            if (participants.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p>Aucun participant pour le moment</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">Ajoutez le premier √©margement ci-dessous</p>
                    </div>
                `;
                generateBtn.disabled = true;
            } else {
                list.innerHTML = participants.map((p, index) => `
                    <div class="participant-card">
                        <div class="participant-info">
                            <div class="participant-number">${index + 1}</div>
                            <div class="participant-details">
                                <div class="participant-name">${p.prenom}</div>
                                <div class="participant-time">${p.heure}</div>
                            </div>
                        </div>
                        <img src="${p.signature}" class="participant-signature" alt="Signature">
                    </div>
                `).join('');
                generateBtn.disabled = false;
            }
        }

        // Gestion du formulaire
        document.getElementById('emargementForm').addEventListener('submit', function(e) {
            e.preventDefault();

            // Reset des messages d'erreur
            document.getElementById('prenomError').classList.remove('show');
            document.getElementById('signatureError').classList.remove('show');

            const prenom = document.getElementById('prenom').value;
            let isValid = true;

            // Validation
            if (!prenom) {
                document.getElementById('prenomError').classList.add('show');
                showToast('error', 'Erreur', 'Veuillez s√©lectionner votre pr√©nom');
                isValid = false;
            }

            if (!hasSignature) {
                document.getElementById('signatureError').classList.add('show');
                showToast('error', 'Erreur', 'Veuillez apposer votre signature');
                isValid = false;
            }

            if (!isValid) return;

            // Ajouter le participant
            const participant = {
                prenom: prenom,
                signature: canvas.toDataURL('image/png'),
                heure: today.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
                timestamp: new Date().toISOString()
            };

            participants.push(participant);

            // Reset le formulaire
            document.getElementById('prenom').value = '';
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            hasSignature = false;

            // Mettre √† jour l'affichage
            updateParticipantsList();

            // Message de succ√®s
            showToast('success', 'Participant ajout√© !', prenom + ' a √©t√© ajout√© √† la liste');

            // Scroll vers la liste
            document.querySelector('.participants-list').scrollIntoView({ behavior: 'smooth' });
        });

        // G√©n√©rer le PDF
        document.getElementById('generateBtn').addEventListener('click', function() {
            if (participants.length === 0) return;

            try {
                console.log('D√©but g√©n√©ration PDF...');
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // En-t√™te - Texte MIDEA stylis√©
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 160, 227); // Couleur bleue Midea
                doc.text('MIDEA', 105, 20, { align: 'center' });

                doc.setTextColor(0, 0, 0); // Retour au noir
                doc.setFontSize(16);
                doc.text('Feuille d\'√âmargement', 105, 32, { align: 'center' });
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text('AKD - Vitrolles', 105, 39, { align: 'center' });
                doc.text('Date : ' + today.toLocaleDateString('fr-FR'), 105, 46, { align: 'center' });

                // Ligne de s√©paration
                doc.setLineWidth(0.5);
                doc.line(20, 51, 190, 51);

                // Participants
                let yPos = 61;
                const maxPerPage = 5;

                participants.forEach((p, index) => {
                    // Nouvelle page si n√©cessaire
                    if (index > 0 && index % maxPerPage === 0) {
                        doc.addPage();
                        yPos = 20;
                    }

                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${index + 1}. ${p.prenom}`, 20, yPos);
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    doc.text(p.heure, 20, yPos + 5);

                    // Signature
                    doc.addImage(p.signature, 'PNG', 100, yPos - 5, 60, 25);
                    doc.setLineWidth(0.2);
                    doc.rect(100, yPos - 5, 60, 25);

                    yPos += 35;
                });

                // Footer sur la derni√®re page
                const pageCount = doc.internal.getNumberOfPages();
                doc.setPage(pageCount);
                doc.setFontSize(9);
                doc.setTextColor(128, 128, 128);
                doc.text('¬© MIDEA HVAC France - Service Apr√®s-Vente', 105, 285, { align: 'center' });

                // Sauvegarder
                const fileName = 'Emargement_Collectif_' + today.toLocaleDateString('fr-FR').replace(/\//g, '-') + '.pdf';
                doc.save(fileName);

                console.log('PDF sauvegard√©');
                showToast('success', 'PDF g√©n√©r√© !', participants.length + ' participant(s) enregistr√©(s)');
            } catch (error) {
                console.error('Erreur g√©n√©ration PDF:', error);
                showToast('error', 'Erreur', 'Impossible de g√©n√©rer le PDF: ' + error.message);
            }
        });
    </script>
</body>
</html>
